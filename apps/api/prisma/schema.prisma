generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  EXPIRED
  CANCELED
  SUSPENDED
}

enum PlanIntervalUnit {
  DAY
  WEEK
  MONTH
  CUSTOM
}

enum PlanType {
  manual_link
  auto_subscription
}

enum PaymentStatus {
  PENDING
  APPROVED
  DECLINED
  ERROR
  VOIDED
}

enum CampaignStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum CampaignSendStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

enum WebhookProvider {
  WOMPI
}

enum WebhookProcessStatus {
  RECEIVED
  PROCESSED
  FAILED
  SKIPPED
}

enum ChatwootMessageType {
  PAYMENT_LINK
  PAYMENT_CONFIRMED
  EXPIRY_WARNING
  PAYMENT_FAILED
}

enum MessageStatus {
  PENDING
  SENT
  FAILED
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

enum CredentialProvider {
  WOMPI
  CHATWOOT
  SHOPIFY
}

enum RetryJobType {
  PROCESS_WOMPI_EVENT
  FORWARD_WOMPI_TO_SHOPIFY
  SEND_CHATWOOT_MESSAGE
  SUBSCRIPTION_REMINDER
  PAYMENT_RETRY
  BILLING_MONTHLY_REPORT
  SEND_CAMPAIGN
  SYNC_SMART_LISTS
}

enum RetryJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
}

enum SaUserRole {
  SUPER_ADMIN
  ADMIN
  AGENT
}

enum SaPeriodType {
  monthly
  total
}

enum SaPlanKind {
  MASTER
  PRO
  ON_DEMAND
}

model Customer {
  id        String   @id @default(uuid()) @db.Uuid
  name      String?
  email     String?  @unique
  phone     String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
  payments      Payment[]
  chatwootMsgs  ChatwootMessage[]
  smartListMembers SmartListMember[]
  campaignSends    CampaignSend[]
}

model SubscriptionPlan {
  id           String           @id @default(uuid()) @db.Uuid
  name         String           @unique
  priceInCents Int
  currency     String           @default("COP")
  intervalUnit PlanIntervalUnit
  intervalCount Int             @default(1)
  planType     PlanType         @default(manual_link)
  active       Boolean          @default(true)
  metadata     Json?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  subscriptions Subscription[]
  paymentLinks  PaymentLink[]
}

model Subscription {
  id                   String             @id @default(uuid()) @db.Uuid
  customerId           String             @db.Uuid
  planId               String             @db.Uuid
  status               SubscriptionStatus @default(ACTIVE)
  startAt              DateTime           @default(now())
  currentPeriodStartAt DateTime           @default(now())
  currentPeriodEndAt   DateTime
  currentCycle         Int                @default(1)
  retryCount           Int                @default(0)
  maxRetries           Int                @default(3)
  canceledAt           DateTime?
  suspendedAt          DateTime?
  metadata             Json?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  customer Customer         @relation(fields: [customerId], references: [id])
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]
  chatwootMsgs ChatwootMessage[]
  paymentLinks PaymentLink[]

  @@index([status, currentPeriodEndAt])
  @@index([customerId])
  @@index([planId])
}

model Payment {
  id                 String        @id @default(uuid()) @db.Uuid
  customerId         String        @db.Uuid
  subscriptionId     String?       @db.Uuid
  paymentLink        PaymentLink?
  amountInCents      Int
  currency           String        @default("COP")
  cycleNumber        Int?
  reference          String
  wompiTransactionId String?
  wompiPaymentLinkId String?       @unique
  checkoutUrl        String?
  subscriptionCycleKey String?     @unique
  status             PaymentStatus @default(PENDING)
  paidAt             DateTime?
  failedAt           DateTime?
  providerResponse   Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  customer     Customer      @relation(fields: [customerId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  attempts     PaymentAttempt[]
  chatwootMsgs ChatwootMessage[]

  @@unique([wompiTransactionId])
  @@index([reference])
  @@index([subscriptionId, status])
}

model PaymentLink {
  id               String   @id @default(uuid()) @db.Uuid
  planId           String   @db.Uuid
  subscriptionId   String   @db.Uuid
  paymentId        String   @unique @db.Uuid
  wompiPaymentLinkId String @unique
  checkoutUrl      String
  status           String   @default("SENT")
  sentAt           DateTime @default(now())
  paidAt           DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  plan         SubscriptionPlan @relation(fields: [planId], references: [id])
  subscription Subscription     @relation(fields: [subscriptionId], references: [id])
  payment      Payment          @relation(fields: [paymentId], references: [id])

  @@index([planId, sentAt])
  @@index([subscriptionId, sentAt])
  @@index([sentAt])
}

model PaymentAttempt {
  id          String   @id @default(uuid()) @db.Uuid
  paymentId   String   @db.Uuid
  attemptNo   Int
  status      String
  errorCode   String?
  errorMessage String?
  provider    String?
  response    Json?
  createdAt   DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
}

model WebhookEvent {
  id            String               @id @default(uuid()) @db.Uuid
  provider      WebhookProvider
  checksum      String               @unique
  eventName     String
  providerTs    BigInt?
  headers       Json?
  payload       Json
  receivedAt    DateTime             @default(now())
  processedAt   DateTime?
  processStatus WebhookProcessStatus @default(RECEIVED)
  errorMessage  String?

  @@index([provider, receivedAt])
  @@index([processStatus, receivedAt])
}

model ChatwootMessage {
  id             String            @id @default(uuid()) @db.Uuid
  customerId     String            @db.Uuid
  subscriptionId String?           @db.Uuid
  paymentId      String?           @db.Uuid
  type           ChatwootMessageType
  status         MessageStatus     @default(PENDING)
  to             String?
  content        String
  providerResp   Json?
  errorMessage   String?
  sentAt         DateTime?
  createdAt      DateTime          @default(now())

  customer     Customer      @relation(fields: [customerId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  payment      Payment?      @relation(fields: [paymentId], references: [id])

  @@index([status, createdAt])
  @@index([customerId])
}

model SmartList {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @unique
  description   String?
  enabled       Boolean  @default(true)
  rules         Json
  chatwootLabel String   @unique
  lastRunAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaigns Campaign[]
  members   SmartListMember[]

  @@index([enabled, createdAt])
}

model SmartListMember {
  id          String   @id @default(uuid()) @db.Uuid
  smartListId String   @db.Uuid
  customerId  String   @db.Uuid
  active      Boolean  @default(true)
  lastSeenAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  smartList SmartList @relation(fields: [smartListId], references: [id])
  customer  Customer  @relation(fields: [customerId], references: [id])

  @@unique([smartListId, customerId])
  @@index([active, updatedAt])
}

model Campaign {
  id            String           @id @default(uuid()) @db.Uuid
  name          String
  smartListId   String?          @db.Uuid
  status        CampaignStatus   @default(DRAFT)
  content       String
  templateParams Json?
  startedAt     DateTime?
  completedAt   DateTime?
  lastError     String?
  sentCount     Int              @default(0)
  failedCount   Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  smartList  SmartList?     @relation(fields: [smartListId], references: [id])
  recipients CampaignSend[]

  @@index([status, createdAt])
  @@index([smartListId])
}

model CampaignSend {
  id          String             @id @default(uuid()) @db.Uuid
  campaignId  String             @db.Uuid
  customerId  String             @db.Uuid
  status      CampaignSendStatus @default(PENDING)
  sentAt      DateTime?
  errorMessage String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@unique([campaignId, customerId])
  @@index([status, createdAt])
  @@index([customerId])
}

model SystemLog {
  id        String   @id @default(uuid()) @db.Uuid
  level     LogLevel
  source    String
  message   String
  context   Json?
  createdAt DateTime @default(now())

  @@index([level, createdAt])
}

model Credential {
  id            String             @id @default(uuid()) @db.Uuid
  provider      CredentialProvider
  key           String
  valueEncrypted String
  version       Int                @default(1)
  active        Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@unique([provider, key])
}

model RetryJob {
  id          String        @id @default(uuid()) @db.Uuid
  type        RetryJobType
  status      RetryJobStatus @default(PENDING)
  runAt       DateTime      @default(now())
  attempts    Int           @default(0)
  maxAttempts Int           @default(10)
  lastError   String?
  payload     Json
  lockedAt    DateTime?
  lockedBy    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status, runAt])
  @@index([type, status])
}

model SaTenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  active    Boolean  @default(true)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      SaUser[]
  planSnaps  SaTenantPlanSnapshot[]
  modules    SaTenantModuleToggle[]
  usageEvents SaUsageEvent[]
  usageCounters SaUsageCounter[]
  billingEvents SaBillingEvent[]
  billingCounters SaBillingCounter[]
}

model SaUser {
  id           String     @id @default(uuid()) @db.Uuid
  tenantId     String?    @db.Uuid
  email        String
  passwordHash String
  role         SaUserRole
  active       Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  tenant SaTenant? @relation(fields: [tenantId], references: [id])

  @@unique([email])
  @@index([tenantId])
  @@index([role])
}

model SaSession {
  id         String   @id @default(uuid()) @db.Uuid
  tokenHash  String   @unique
  email      String
  createdAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  ip         String?
  userAgent  String?

  @@index([email, expiresAt])
  @@index([expiresAt])
}

model SaModuleDefinition {
  key       String  @id
  name      String
  active    Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  toggles SaTenantModuleToggle[]
}

model SaTenantModuleToggle {
  id        String  @id @default(uuid()) @db.Uuid
  tenantId  String  @db.Uuid
  moduleKey String
  enabled   Boolean @default(true)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  tenant SaTenant @relation(fields: [tenantId], references: [id])
  module SaModuleDefinition @relation(fields: [moduleKey], references: [key])

  @@unique([tenantId, moduleKey])
  @@index([tenantId])
}

model SaLimitDefinition {
  key        String       @id
  name       String
  periodType SaPeriodType
  moduleKey  String?
  active     Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([moduleKey])
}

model SaPlanDefinition {
  id                 String     @id @default(uuid()) @db.Uuid
  key                String     @unique
  name               String
  kind               SaPlanKind
  monthlyPriceInCents Int       @default(0)
  active             Boolean    @default(true)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  services SaPlanServiceLimit[]
  tenantSnaps SaTenantPlanSnapshot[]
}

model SaPlanServiceLimit {
  id            String   @id @default(uuid()) @db.Uuid
  planId        String   @db.Uuid
  serviceKey    String
  isUnlimited   Boolean  @default(false)
  maxValue      Int?
  unitPriceInCents Int   @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  plan SaPlanDefinition @relation(fields: [planId], references: [id])

  @@unique([planId, serviceKey])
  @@index([serviceKey])
}

model SaTenantPlanSnapshot {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  planId    String   @db.Uuid
  active    Boolean  @default(true)
  snapshot  Json
  startsAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant SaTenant @relation(fields: [tenantId], references: [id])
  plan   SaPlanDefinition @relation(fields: [planId], references: [id])

  @@index([tenantId, active])
  @@index([planId])
}

model SaUsageEvent {
  id         String      @id @default(uuid()) @db.Uuid
  tenantId   String      @db.Uuid
  serviceKey String
  amount     Int
  periodType SaPeriodType
  periodKey  String
  source     String?
  meta       Json?
  createdAt  DateTime    @default(now())

  tenant SaTenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, periodKey])
  @@index([serviceKey, periodKey])
  @@index([createdAt])
}

model SaUsageCounter {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  serviceKey String
  periodKey  String
  total      Int      @default(0)
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  tenant SaTenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, serviceKey, periodKey])
  @@index([tenantId, periodKey])
}

model SaBillingEvent {
  id            String      @id @default(uuid()) @db.Uuid
  tenantId      String      @db.Uuid
  serviceKey    String
  quantity      Int
  unitPriceInCents Int
  totalInCents  Int
  periodType    SaPeriodType
  periodKey     String
  meta          Json?
  createdAt     DateTime    @default(now())

  tenant SaTenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, periodKey])
  @@index([serviceKey, periodKey])
  @@index([createdAt])
}

model SaBillingCounter {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  serviceKey    String
  periodKey     String
  totalQuantity Int      @default(0)
  totalInCents  Int      @default(0)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  tenant SaTenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, serviceKey, periodKey])
  @@index([tenantId, periodKey])
}
